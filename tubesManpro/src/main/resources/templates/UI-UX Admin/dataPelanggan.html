<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newci Wash Master</title>
    <link rel="stylesheet" href="/styleAdmin.css">
    <link rel="stylesheet" href="/Pelanggan.css">
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>Admin Dashboard</h2>
        <nav>
            <ul>
                <li><a th:href="@{/admin}">Data Pegawai</a></li>
                <li><a th:href="@{/UI-UX Admin/dataKecamatan}">Data Kecamatan</a></li>
                <li><a th:href="@{/UI-UX Admin/dataKelurahan}">Data Kelurahan</a></li>
                <li><a th:href="@{/UI-UX Admin/dataPelanggan}">Data Pelanggan</a></li>
                <li><a th:href="@{/UI-UX Admin/dataMesin}">Data Mesin Cuci & Tarif</a></li>
                <li><a th:href="@{/UI-UX Admin/dataTransaksi}">Data Transaksi</a></li>
                <br><br><br><br><br><br><br><br><br><br><br>
                <li id="logout"><a th:href="@{/login}">Log Out</a></li>
            </ul>
        </nav>
    </div>

    <div class="content">
        <header>
            <h1>Selamat Datang, Admin!</h1>
        </header>

        <section id="data-pelanggan">
            <h2>Data Pelanggan</h2>
            <button id="tambah-pelanggan-button" type="button">Tambah Pelanggan</button>
            <div id="form-tambah-pelanggan" style="display: none;">
                <h3>Form Tambah Pelanggan</h3>
                <form id="form-pelanggan" method="POST" action="/api/pelanggan/add">
                    <label for="nama">Nama</label>
                    <input type="text" id="nama" name="nama" required>
                    <label for="telepon">No. Telepon</label>
                    <input type="text" id="telepon" name="telepon" required>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                    <label for="kecamatan">Kecamatan</label>
                    <select id="kecamatan" name="kecamatan" required>
                        <option value="" disabled selected>Pilih Kecamatan</option>
                    </select>
                    <label for="kelurahan">Kelurahan:</label>
                    <select id="kelurahan" name="kelurahan" required>
                        <option value="" disabled selected>Pilih Kelurahan</option>
                    </select>
                    <div id="kelurahan-warning" style="color: red; display: none;">
                        Kelurahan belum tersedia. Harap tambahkan data kelurahan terlebih dahulu.
                    </div>
                    <button type="submit">Simpan</button>
                    <button type="button" id="cancel-pelanggan-button">Batal</button>
                </form>
            </div>
            <table>
                <tr>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>No. Telepon</th>
                    <th>Email</th>
                    <th>Kecamatan</th>
                    <th>Kelurahan</th>
                    <th>Aksi</th>
                </tr>
            </table>
        </section>
    </div>

    <script>
        const tambahPelangganButton = document.getElementById('tambah-pelanggan-button');
        const formTambahPelanggan = document.getElementById('form-tambah-pelanggan');
        const cancelPelangganButton = document.getElementById('cancel-pelanggan-button');

        tambahPelangganButton.addEventListener('click', () => {
            formTambahPelanggan.style.display = 'block';
            tambahPelangganButton.style.display = 'none';
        });

        cancelPelangganButton.addEventListener('click', () => {
            formTambahPelanggan.style.display = 'none';
            tambahPelangganButton.style.display = 'block';
        });

        document.addEventListener("DOMContentLoaded", () => {
            const kecamatanDropdown = document.getElementById('kecamatan');

            function loadKecamatanDropdown() {
                fetch('/api/kecamatan/list')
                    .then(response => response.json())
                    .then(kecamatanList => {
                        // Bersihkan dropdown sebelum menambahkan data
                        kecamatanDropdown.innerHTML = '<option value="" disabled selected>Pilih Kecamatan</option>';
                        
                        // Tambahkan opsi untuk setiap kecamatan
                        kecamatanList.forEach(kecamatan => {
                            const option = document.createElement('option');
                            option.value = kecamatan.id;
                            option.textContent = kecamatan.namaKecamatan;
                            kecamatanDropdown.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Gagal memuat data kecamatan:', error));
            }

            // Panggil fungsi untuk mengisi dropdown
            loadKecamatanDropdown();
        });

        // Fungsi untuk memuat data kelurahan berdasarkan kecamatan
        function loadKelurahan(kecamatan) {
            fetch(`/api/kelurahan/by-kecamatan/${kecamatan}`)
                .then(response => response.json())
                .then(data => {
                    const kelurahanSelect = document.getElementById('kelurahan');
                    const kelurahanWarning = document.getElementById('kelurahan-warning');

                    if (data.length === 0) {
                        kelurahanSelect.style.display = 'none';
                        kelurahanWarning.style.display = 'block';
                    } else {
                        kelurahanSelect.innerHTML = '<option value="" disabled selected>Pilih Kelurahan</option>';
                        data.forEach(kelurahan => {
                            const option = document.createElement('option');
                            option.value = kelurahan.id;
                            option.textContent = kelurahan.namaKelurahan;
                            kelurahanSelect.appendChild(option);
                        });

                        kelurahanSelect.style.display = 'block';
                        kelurahanWarning.style.display = 'none';
                    }
                })
            .catch(error => console.error('Gagal memuat data kelurahan:', error));
        }

        // Hubungkan dropdown kecamatan dan kelurahan
        document.getElementById('kecamatan').addEventListener('change', event => {
            const kecamatan = event.target.value;
            if (kecamatan) {
                loadKelurahan(kecamatan);
            }
        });

        document.getElementById('form-pelanggan').addEventListener('submit', function(event) {
            event.preventDefault(); // Mencegah reload halaman

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            fetch('/api/pelanggan/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nama: formData.get('nama'),
                    telepon: formData.get('telepon'),
                    email: formData.get('email'),
                    kecamatan: formData.get('kecamatan'),
                    kelurahan: formData.get('kelurahan')
                }),
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message); // Tampilkan pesan sukses
                loadPelangganTable(); // Perbarui tabel
                this.reset(); // Reset form
                document.getElementById('form-tambah-pelanggan').style.display = 'none';
                document.getElementById('tambah-pelanggan-button').style.display = 'block';
            })
            .catch(error => console.error('Gagal menyimpan data:', error));
        });

        function loadPelangganTable() {
            fetch('/api/pelanggan/all')
                .then(response => response.json())
                .then(data => {
                    const table = document.querySelector('table');
                    const rows = data.map(pelanggan => `
                        <tr>
                            <td>${pelanggan.id}</td>
                            <td>${pelanggan.nama}</td>
                            <td>${pelanggan.telepon}</td>
                            <td>${pelanggan.email}</td>
                            <td>${pelanggan.kecamatan}</td>
                            <td>${pelanggan.kelurahan}</td>
                            <td>
                                <button onclick="deletePelanggan(${pelanggan.id})">Hapus</button>
                                <button onclick="editPelanggan(${pelanggan.id})">Edit</button>
                            </td>
                        </tr>
                    `).join('');
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>No. Telepon</th>
                            <th>Email</th>
                            <th>Kecamatan</th>
                            <th>Kelurahan</th>
                            <th>Aksi</th>
                        </tr>
                        ${rows}
                    `;
                })
                .catch(error => console.error('Gagal memuat data pelanggan:', error));
        }

        function deletePelanggan(id) {
            if (confirm('Apakah Anda yakin ingin menghapus pelanggan ini?')) {
                fetch(`/api/pelanggan/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                        alert(result.message);
                        loadPelangganTable(); // Perbarui tabel
                    })
                    .catch(error => console.error('Gagal menghapus data:', error));
            }
        }

        // Panggil fungsi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadPelangganTable);


        // Panggil fungsi loadKecamatan saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadKecamatan);
    </script>
</body>

</html>